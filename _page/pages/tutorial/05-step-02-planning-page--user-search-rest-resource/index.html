{% set bodyClass = "cs-tutorial" %}
{% extends layoutSourceDir + "/layout_with_sidebar.html" %}
{% block head %}
    <title>User Search REST Resource ~ Planning Page | Kitchen Duty Plugin for Atlassian JIRA® by comSysto</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by comSysto">
    <meta name="robots" content="noindex, nofollow">
{% endblock %}
{% block content %}



{{ pageHeader(5) }}


<div class="container-fluid cs-content">
    <div class="row">
        <div class="col-md-12">
            {{ headline('User Search REST Resource', 'm') }}





            {# ############################################################# #}
            {# STEP 2 USER SEARCH REST #}
            {# ############################################################# #}



            <p>We will now create the <strong>User Search REST Resource</strong> so that our <strong>JS-Controller can search for usernames</strong>.</p>

            <p>What is a REST Resource? It is simply just a basic Controller (MVC) that reacts to certain HTTP Requests with a specific response.</p>

            <p>
                Atlassian uses <a target="_blank" href="https://en.wikipedia.org/wiki/Java_API_for_XML_Web_Services">JAX-WS</a> and <a target="_blank" href="https://en.wikipedia.org/wiki/Java_Architecture_for_XML_Binding">JAXB</a> for it's built in REST Resources.
                The actual implementation is hidden from us, and we don't really care about it since we just need to know that somewhere inside JIRA
                are OSGi bundles which provide the JAX-WS and JAXB implementation.</p>

            <p>Ok, enough of OSGi and theoretical jibber jabber! Let's create our REST Resource with an Atlassian SDK command, like we did create the Webwork Action before.</p>

            <p>Execute the command and choose <a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/rest-api-development/rest-plugin-module" target="_blank"><strong>14: REST Plugin Module</strong></a> and fill out the prompts as stated below.</p>

            {{ csShell(shellCmd='atlas-create-jira-plugin-module', shellCmdOutput='
                        |Executing: /Applications/Atlassian/atlassian-plugin-sdk-6.1.0/apache-maven-3.2.1/bin/mvn com.atlassian.maven.plugins:maven-jira-plugin:6.1.2:create-plugin-module -gs /Applications/Atlassian/atlassian-plugin-sdk-6.1.0/apache-maven-3.2.1/conf/settings.xml
                        |Java HotSpot(TM) 64-Bit Server VM warning: ignoring option MaxPermSize=256M; support was removed in 8.0
                        |[INFO] Scanning for projects...
                        |[INFO]
                        |[INFO] Using the builder org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder with a thread count of 1
                        |[INFO]
                        |[INFO] ------------------------------------------------------------------------
                        |[INFO] Building kitchen-duty-plugin 1.0.0-SNAPSHOT
                        |[INFO] ------------------------------------------------------------------------
                        |[INFO]
                        |[INFO] --- maven-jira-plugin:6.1.2:create-plugin-module (default-cli) @ kitchen-duty-plugin ---
                        |Choose Plugin Module:
                        |1:  Component Import
                        |...
                        |14: REST Plugin Module
                        |15: RPC Endpoint Plugin
                        |...
                        |Choose a number (...): 14
                        |
                        |Enter New Classname MyRestResource: : UserSearchResource
                        |Enter Package Name com.comsysto.rest: : com.comsysto.kitchen.duty.rest
                        |Enter REST Path /usersearchresource: : /kitchenduty
                        |Enter Version 1.0: : 1.0
                        |
                        |Show Advanced Setup? (Y/y/N/n) N: : y
                        |
                        |Module Name User Search Resource: : Kitchen Duty Resources
                        |Module Key user-search-resource: : kitchen-duty-resources
                        |Module Description The User Search Resource Plugin: : All Kitchen Duty REST Resources
                        |i18n Name Key user-search-resource.name: : kitchen-duty-plugin.rest.resources.name
                        |i18n Description Key user-search-resource.description: : kitchen-duty-plugin.rest.resources.description
                        |Add Package To Scan? (Y/y/N/n) N: : y
                        |Enter Package: com.comsysto.kitchen.duty.rest
                        |...
                        |
                        |Add Package To Scan? (Y/y/N/n) N: : n
                        |
                        |Add Dispatcher? (Y/y/N/n) N: : n
                        |
                        |[INFO] Adding the following items to the project:
                        |[INFO]   [class: com.comsysto.kitchen.duty.rest.UserSearchResourceModel]
                        |[INFO]   [class: com.comsysto.kitchen.duty.rest.UserSearchResource]
                        |[INFO]   [class: it.com.comsysto.kitchen.duty.rest.UserSearchResourceFuncTest]
                        |[INFO]   [class: ut.com.comsysto.kitchen.duty.rest.UserSearchResourceTest]
                        |[INFO]   [dependency: com.atlassian.plugins.rest:atlassian-rest-common]
                        |[INFO]   [dependency: com.atlassian.sal:sal-api]
                        |[INFO]   [dependency: javax.servlet:servlet-api]
                        |[INFO]   [dependency: javax.ws.rs:jsr311-api]
                        |[INFO]   [dependency: javax.xml.bind:jaxb-api]
                        |[INFO]   [dependency: org.apache.wink:wink-client]
                        |[INFO]   [dependency: org.mockito:mockito-all]
                        |[INFO]   [module: rest]
                        |[INFO]   i18n strings: 2
                        |
                        |Add Another Plugin Module? (Y/y/N/n) N: : n
                        |
                        |[INFO] ------------------------------------------------------------------------
                        |[INFO] BUILD SUCCESS
                        |[INFO] ------------------------------------------------------------------------
                        |[INFO] Total time: 01:52 min
                        |[INFO] Finished at: 2016-01-16T20:07:35+01:00
                        |[INFO] Final Memory: 24M/328M
                        |[INFO] ------------------------------------------------------------------------
                    ') }}


            <p>The SDK created and updated many files now and before we get into all the details let's fire up <code>atlas-run</code> again
                and see what has been created for us.</p>

            <p>Once JIRA is started <strong>browse to <a class="cs-do-wrap" href="http://server/jira/rest/kitchenduty/1.0/message" target="_blank">http://server/jira/rest/kitchenduty/1.0/message</a></strong> and you should see the following.</p>

            <div class="row">
                <div class="col-md-offset-2 col-md-8">
                    <p>
                        <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-02-rest-user-search-response-xml.png" data-lightbox="02-step" data-title="Step 2 - XML Response of User Search REST Resource">
                            <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-02-rest-user-search-response-xml.png" class="img-thumbnail img-responsive" alt="Step 2 - XML Response of User Search REST Resource">
                        </a>
                    </p>
                </div>
            </div>

            <p>That's nice. But now we need to understand what is going on. So here is a <strong>short recap of what has been created</strong>.</p>

            <ol>
                <li><p>The <code>pom.xml</code> has been altered to provide necessary dependencies for JAX-WS API, Servlet API and some testing Dependencies.</p></li>
                <li><p>The <code>atlassian-plugin.xml</code> has been altered to register the REST Resource to listen to the baseUrl <code>http://server/jira/rest/kitchenduty/1.0/*</code></p></li>
                <li><p>There now is a <code>UserSearchResource.java</code> which is the actual REST Controller which delivers the response.</p></li>
                <li><p>In addition to the REST Controller there is <code>UserSearchResourceModel.java</code> which is the Model which is delivered as XML in the REST Controllers response.</p></li>
            </ol>

            <p>We will now get into all the details and implement the needed features for the user search on the fly.</p>

            <h3 class="cs-headline cs-headline--s">1. Dependencies <em>(pom.xml)</em></h3>

            <p>The <code>pom.xml</code> has these new lines which are quite self explanatory. If you want to read everything in detail read the <a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/rest-api-development/rest-plugin-module" target="_blank">REST Plugin Module documentation</a>.</p>

            {{ csSource(lang='xml', source='
                        |<dependency>
                        |    <groupId>javax.servlet</groupId>
                        |    <artifactId>servlet-api</artifactId>
                        |    <version>2.4</version>
                        |    <scope>provided</scope>
                        |</dependency>
                        |<dependency>
                        |    <groupId>javax.xml.bind</groupId>
                        |    <artifactId>jaxb-api</artifactId>
                        |    <version>2.1</version>
                        |    <scope>provided</scope>
                        |</dependency>
                        |<dependency>
                        |    <groupId>com.atlassian.plugins.rest</groupId>
                        |    <artifactId>atlassian-rest-common</artifactId>
                        |    <version>1.0.2</version>
                        |    <scope>provided</scope>
                        |</dependency>
                        |<dependency>
                        |    <groupId>org.apache.wink</groupId>
                        |    <artifactId>wink-client</artifactId>
                        |    <version>1.1.3-incubating</version>
                        |    <scope>test</scope>
                        |</dependency>
                    ') }}

            {# CHECK IF NECESSARY!

            <p>But we will change the <code>servlet-api</code> to version <code>3.0</code> since that is the API we will code against and which is running inside current JIRA versions. So change it like this.</p>

            {{ csSource(lang='xml', source='
                |<dependency>
                |    <groupId>javax.servlet</groupId>
                |    <artifactId>servlet-api</artifactId>
                |    <version>2.4</version>
                |    <scope>provided</scope>
                |</dependency>
            ') }}

            #}




            <h3 class="cs-headline cs-headline--s">2. REST Resources Handler <em>(atlassian-plugin.xml)</em></h3>

            <p>As already mentioned the <code>atlassian-plugin.xml</code> has been altered to register the REST Resource to listen to the baseUrl <code>http://server/jira/rest/kitchenduty/1.0/*</code>.</p>

            <p>The <code>path</code> and <code>version</code> build the baseurl relative to <code>http://server/jira/rest/*</code>.</p>

            <p><code>package</code> will enable Component Scan (which I think is redundant, but doesn't hurt).</p>

            {{ csSource(lang='xml', source='
                        |<rest name="Kitchen Duty Resources"
                        |      i18n-name-key="kitchen-duty-plugin.rest.resources.name"
                        |      key="kitchen-duty-resources"
                        |      path="/kitchenduty"
                        |      version="1.0">
                        |  <description key="kitchen-duty-plugin.rest.resources.description">All Kitchen Duty REST Resources</description>
                        |  <package>com.comsysto.kitchen.duty.rest</package>
                        |</rest>
                    ') }}

            <p>You already know <code>i18n-name-key</code> and the other attributes from the Webwork Action and therefore are not wondering that there are some new i18n key/value pairs inside <code>kitchen-duty-plugin.properties</code>.</p>

            {{ csSource(lang='ini', source='
                        |kitchen-duty-plugin.rest.resources.name=Kitchen Duty Resources
                        |kitchen-duty-plugin.rest.resources.description=All Kitchen Duty REST Resources
                    ') }}


            <h3 class="cs-headline cs-headline--s">3. REST Controller and Model</h3>

            <p>
                In the directory <code>src/main/java/</code> in the package <code>com.comsysto.kitchen.duty.rest</code> there is now the
                <code>UserSearchResource.java</code> and the <code>UserSearchResourceModel.java</code>. You can see what has been created in the <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/commit/95b8ebf5ff20a77c6b0853cd93ad0b465033e6f6">GitHub commit 95b8ebf</a>.
            </p>

            <p>
                We will change the code to <strong>provide GET Endpoint to search usernames</strong>.
            </p>

            <div class="row">
                <div class="col-md-6">
                    {%  set uniqueIdUserSearchResourceStep2 = 'step2-usersearchresource' %}
                    {{ csSource(lang='java', filename="UserSearchResource.java", uniqueId=uniqueIdUserSearchResourceStep2, source='
                                |package com.comsysto.kitchen.duty.rest;
                                |
                                |import com.atlassian.jira.bc.user.search.UserSearchParams;
                                |import com.atlassian.jira.bc.user.search.UserSearchService;
                                |import com.atlassian.plugins.rest.common.security.AnonymousAllowed;
                                |
                                |import javax.inject.Inject;
                                |import javax.inject.Named;
                                |import javax.servlet.http.HttpServletRequest;
                                |import javax.ws.rs.GET;
                                |import javax.ws.rs.Path;
                                |import javax.ws.rs.Produces;
                                |import javax.ws.rs.QueryParam;
                                |import javax.ws.rs.core.Context;
                                |import javax.ws.rs.core.MediaType;
                                |import javax.ws.rs.core.Response;
                                |import java.util.ArrayList;
                                |import java.util.List;
                                |
                                |@Named {{{point::1}}}
                                |@Path("/user")  {{{point::2}}}
                                |public class UserSearchResource {
                                |
                                |    private UserSearchService userSearchService; {{{point::3}}}
                                |
                                |    @Inject {{{point::4}}}
                                |    public UserSearchResource(UserSearchService userSearchService) {
                                |        this.userSearchService = userSearchService;
                                |    }
                                |
                                |    {{{point::5}}}
                                |    public UserSearchResource() {
                                |    }
                                |
                                |    @GET
                                |    @Path("/health") {{{point::6}}}
                                |    @Produces({MediaType.APPLICATION_JSON})
                                |    @AnonymousAllowed {{{point::7}}}
                                |    public Response health() {
                                |        return Response.ok("ok").build();
                                |    }
                                |
                                |    /**
                                |     * Call from select2 JS plugin
                                |     * Response needs to look like this:
                                |     * [{ \'id\': 1, \'text\': \'Demo\' }, { \'id\': 2, \'text\': \'Demo 2\'}]
                                |     */
                                |    @GET
                                |    @Path("/search") {{{point::8}}}
                                |    @Produces({MediaType.APPLICATION_JSON})
                                |    public Response searchUsers(@QueryParam("query") final String userQuery, {{{point::9}}}
                                |                                @Context HttpServletRequest request {{{point::10}}}) {
                                |        List<UserSearchResourceModel> users = findUsers(userQuery);
                                |        return Response.ok(users).build(); {{{point::11}}}
                                |    }
                                |
                                |    private List<UserSearchResourceModel> findUsers(String query) {
                                |        List<UserSearchResourceModel> userSearchResourceModels =
                                |                                           new ArrayList<UserSearchResourceModel>();
                                |        UserSearchParams searchParams = UserSearchParams.builder()
                                |            .includeActive(true)
                                |            .sorted(true)
                                |            .build();
                                |        List<String> users = userSearchService.findUserNames(query, searchParams); {{{point::12}}}
                                |        if (users != null) {
                                |            for (String user : users) {
                                |                userSearchResourceModels.add(new UserSearchResourceModel(user, user));
                                |            }
                                |        }
                                |        return userSearchResourceModels;
                                |    }
                                |}
                            ') }}
                </div>
                <div class="col-md-6">

                    <div class="list-group cs-source-point-list" data-source-target="{{ uniqueIdUserSearchResourceStep2 }}">
                        <div class="list-group-item cs-source-point-list__item">
                            Our REST Controller should be a Spring-Bean and get its dependencies autowired. Therefore provide the JSR annotation <code>@Named</code>
                            on classlevel.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            We want that all REST Endpoints of our REST Controller will have an URL-prefix <code>/user</code>, therefore we use the <code>@Path</code> annotation.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            The <code>UserSearchService</code> is a JIRA Service which will provide us methods to search for users. This Servie needs to be imported from a foreign OSGi bundle, we will see about that later.
                            Why not use <code>@ComponentImport</code> here you ask? Well try and if it works for you that would be nice. But I am getting some strange WADLGenerator Exceptions when running <code>atlas-integration-test</code>.
                            Therefore I use a little trick and import the component somewhere else. Once it is imported somewhere inside our bundle we can use it here. We will see about that later.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            We use <code>@Inject</code> for constructor injection, so that our UserSearchService will be injected by Spring on bean creation.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            We provide a default constructor just in case.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            Since our user search Endpoint will be rather complex we want a simple health endpoint to test the REST API in an easy way.
                            Therefore we define a Method as <code>@GET</code> with <code>@Path("/health")</code> which produces JSON <code>@Produces({MediaType.APPLICATION_JSON})</code>.
                            This endpoint will be reachable via <code>http://localhost:2990/jira/rest/kitchenduty/1.0/user/health</code>.
                        </div>
                        <a class="list-group-item cs-source-point-list__item">
                            The health endpoint will be reachable without authentication via <code>@AnonymousAllowed</code>.
                            So you can curl the URL easily and will get an <code>ok</code> as response.
                        </a>
                        <div class="list-group-item cs-source-point-list__item">
                            Alright now we code the actual user search Endpoint with <code>@Path("/search")</code>. We do NOT use <code>@AnonymousAllowed</code> here
                            because we don't want unauthenticated users search our user database.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            As we want to search for username, somehow our search keyword needs to be passed as URL-parameter. This
                            is done via <code>@QueryParam("query")</code> which leads to the following URL for our endpoint
                            <code>http://localhost:2990/jira/rest/kitchenduty/1.0/user/search?query=foo</code>.
                            <br><br>Why use QueryParam instead of PathParam you ask? I see you like nice URL-patterns and so do I, but we will see later that the AUI select2 widget
                            will send the search keyword as <code>query</code> param, so we stick to this default behaviour.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            With <code>@Context HttpServletRequest request</code> we get the HTTP-Request as paramater and could for example extract the authenticated user.
                            We don't need it now but we might soon. <code>@Context</code> ensures that JIRA context (I think special headers and stuff) is wired into the request.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            After we searched for users we build the response with <code>Response.ok(someObject).build()</code>.
                            The JAXB/JAX-WS implementation ensures that our Model (we will see about that later) is converted to JSON and that a HTTP 200 is send together with the JSON representation of our Object as response body.
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            We provide a private method that searches for usernames using the <code>UserSearchService</code>. If your OSGi component imports are not working correctly you will get a <em>NullPointerException</em> here.
                            After we searched the usernames we convert the username list into our model <code>UserSearchResourceModel</code> which will be serialized as JSON response body.
                        </div>
                    </div>
                </div>

            </div>



            <div class="cs-v-spacer cs-v-spacer"></div>



            <p>
                Now we have the REST Controller but you will have some compile errors now because the <strong>Model needs to be implemented</strong>.
            </p>

            <div class="row">
                <div class="col-md-6">
                    {%  set uniqueIdUserSearchResourceModelStep2 = 'step2-usersearchresourcemodel' %}
                    {{ csSource(lang='java', filename="UserSearchResourceModel.java", uniqueId=uniqueIdUserSearchResourceModelStep2, source='
                                |package com.comsysto.kitchen.duty.rest;
                                |
                                |import javax.xml.bind.annotation.*;
                                |@XmlRootElement(name = "users") {{{point::1}}}
                                |@XmlAccessorType(XmlAccessType.FIELD) {{{point::2}}}
                                |public class UserSearchResourceModel {
                                |
                                |    @XmlElement {{{point::3}}}
                                |    private String text;
                                |
                                |    @XmlElement {{{point::4}}}
                                |    private String id;
                                |
                                |    public UserSearchResourceModel() {
                                |    }
                                |
                                |    public UserSearchResourceModel(String text, String id) {
                                |        this.text = text;
                                |        this.id = id;
                                |    }
                                |
                                |    public String getText() {
                                |        return text;
                                |    }
                                |
                                |    public void setText(String text) {
                                |        this.text = text;
                                |    }
                                |
                                |    public String getId() {
                                |        return id;
                                |    }
                                |
                                |    public void setId(String id) {
                                |        this.id = id;
                                |    }
                                |}
                            ') }}
                </div>
                <div class="col-md-6">

                    <div class="list-group cs-source-point-list" data-source-target="{{ uniqueIdUserSearchResourceModelStep2 }}">
                        <div class="list-group-item cs-source-point-list__item">
                            ...
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            ...
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            ...
                        </div>
                        <div class="list-group-item cs-source-point-list__item">
                            ...
                        </div>

                    </div>
                </div>

            </div>


            <strong style="color:red">todo</strong>
            <ul style="color:red">
                <li>model</li>
                <li>component import</li>
                <li>Explain Unit and Integration test and altas-integration-test</li>

                <li>atlas-run and curl to username search</li>
                <li>summary and step2 conclusion - <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/commit/32094a91a93b9e05c839975df3ce8aa104c94bb1">32094a9</a> </li>
            </ul>

            {#
            src/test/java/it/com/comsysto/kitchen/duty/rest/UserSearchResourceFuncTest.java

            src/test/java/ut/com/comsysto/kitchen/duty/rest/UserSearchResourceTest.java
            #}



            <div class="cs-v-spacer cs-v-spacer--big"></div>

        </div>
    </div>
</div>

{% endblock %}
