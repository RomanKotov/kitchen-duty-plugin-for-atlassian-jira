{% set CURRENT_PAGE_ID = 6 %}
{% set gitHubBaseUrlForStep3 = 'https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-03-kitchen-duty-plugin/' %}
{% extends layoutSourceDir + "/layout_with_sidebar.html" %}
{% block head %}
    <title>User Search JS Controller ~ Planning Page | Kitchen Duty Plugin for Atlassian JIRA® by comSysto</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by comSysto">
    <meta name="robots" content="noindex, nofollow">
{% endblock %}
{% block content %}



<div class="row">
    <div class="col-md-12">
        {{ headline('User Search JS Controller', 'm') }}



        {# ############################################################# #}
        {# STEP 3 USER SEARCH JS CONTROLLER #}
        {# ############################################################# #}


        <p>In the previous section we implemented the User Search REST Endpoint which we will now use
        from our JS Controller. You might want to check the <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">Story Workshop</a> again to see what we
        want to build here.</p>


        <h3 class="cs-headline cs-headline--s">AUI and JIRA Version?</h3>


        <div class="row">
            <div class="col-md-6">
                <p>Ok so we want to use the <strong><a href="https://docs.atlassian.com/aui/latest/docs/auiselect2.html">Select2 Widget from the AUI Framework</a></strong>.
                    First you have to know that each version of JIRA has AUI prepackaged in a certain version.
                    Therefore we will use that and not pull in a second version of that (really, don't do that).</p>

                <p>So we do a <code>atlas-run</code> and wait for JIRA to startup. Now open the Browser Console
                    and type:</p>


                {{ csShell(shellCmd='AJS.version', shellCmdOutput='
                    |5.7.31
                ') }}


                <p>It will print the exact version used in the JIRA target version we code our plugin for.
                    At this point you really have to think about the range of versions you want to support with
                    your plugin. If you want to support older JIRA versions you need to know the lowest version of AUI
                    availabe and code with backwardscompatibility in mind. To make things simpler we assume that our
                    plugin will be compatible starting from JIRA 7.0 up to the latest JIRA version (currently 7.1.x).</p>

                <p>Alright now open the
                    <a href="https://docs.atlassian.com/aui/5.7.31/docs/applicationHeader.html" target="_blank">AUI documentation for 5.7.31</a>
                    and select AUI Select 2 documentation.
                    Ok no offense to the people writing the docs but it is a little thin and it took me some
                    time to come up with a hassle-free way to use the Select 2 the way I want it to behave.
                    You just read the doc and I will provide you some code you should like.</p>
            </div>
            <div class="col-md-offset-1 col-md-5">
                <p>
                    <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-ajs-version.png" data-lightbox="03-step" data-title="Step 3 - Find out the AJS/AUI Version">
                        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-ajs-version.png" class="img-thumbnail img-fluid" alt="Step 2 - Find out the AJS/AUI Version">
                    </a>
                </p>
            </div>
        </div>


        <h3 class="cs-headline cs-headline--s">What about JS Frameworks, Template Engines and jQuery?</h3>

        <p>Alright that is it about our Widget. But how do we write our JavaScript code?
        Is there any template engine? Any watchers and/or frameworks? You have good point there.
        Let me tell you a short tale about JIRA and JavaScript...

        <p>Ok basically we already used <code>AJS.version</code> before, so you might have already wondered
        what that actually was. <strong>JIRA bundles a lightweight jQuery which is bound to <code>AJS</code></strong>
        there is no <code>$</code> or <code>jQuery</code> and even if there were you are advised to
        use <code>AJS</code> prefix. So here is a basic example:</p>


        {{ csShell(shellCmd="var theFooElement = AJS.$('#foo');", shellCmdOutput='
                    |undefined
                ') }}

        <p>It will select the DOM element with id foo (when there is no such element it will return <code>undefined</code>).
            Ok just take that in for now, I know it is unfamiliar but we will get used to it.</p>

        <p>So what about template Engines? There is <a href="https://docs.atlassian.com/aui/latest/docs/soy.html" target="_blank">soy</a> which
            is basically the <a href="https://developers.google.com/closure/templates/"  target="_blank">Google Closure Template Framework</a>
            which can be used server-side and client-side. We will stick with velocity for server-side templates (you could switch to soy completely).
            And we will use soy-templates on the client-side.</p>

        <div class="cs-blockquote">
            <p>
                Small is beautiful - Avoid using big JavaScript frameworks that will register globals, bring in dependencies and tend to overwrite stuff that might break JIRA functionality.
                In most cases AUI already provides a way to solve your problem.
            </p>
        </div>


        <p>Alright let's resume what we are going to use:</p>

        <ul>
            <li>lightweight jQuery provided with <code>AJS</code> prefix</li>
            <li>AUI framework methods like <code>AJS.getI18nText</code></li>
            <li><a href="https://developer.atlassian.com/confdev/tutorials/writing-soy-templates-in-your-plugin" target="_blank">soy templates</a> (<a href="https://developers.google.com/closure/templates/"  target="_blank">Google Closure Template Framework</a>)</li>
            <li>html page with serverside velocity (which we will not use to much)</li>
        </ul>



        <h3 class="cs-headline cs-headline--s">Basic setup of JS Dependencies and Controller</h3>

        <p>Now we <strong>create our JS-Controller</strong> file in <code>/src/main/resources/js/kitchen-duty-plugin--planning-page-controller.js</code>.
        We put some simple dummy code inside which will trigger a <a href="https://docs.atlassian.com/aui/5.7.31/docs/flag.html">message flag</a> on pageload just to see if everything is working.</p>

        {{ csSource(lang='js', filename="src/main/resources/js/kitchen-duty-plugin--planning-page-controller.js", ghBaseUrl=gitHubBaseUrlForStep3, source="
            |AJS.toInit(function(){
            |   require(['aui/flag'], function(flag) {
            |       var myFlag = flag({
            |           type: 'success',
            |           title: 'Kitchen Duty Plugin',
            |           body: 'JS Controller is working'
            |       });
            |   });
            |});
        ") }}

        <p>Our new JS Controller will not just work out of the box. We need to define a resource in <code>atlassian-plugin.xml</code>
            for our controller.</p>

        {{ csSource(lang='xml', filename="src/main/resources/atlassian-plugin.xml", ghBaseUrl=gitHubBaseUrlForStep3, source='
            |<web-resource key="kitchen-duty-plugin-resources--planning-page" name="kitchen-duty-plugin Web Resources for Planning Page">
            |	<dependency>com.atlassian.auiplugin:ajs</dependency>
            |	<resource type="download" name="kitchen-duty-plugin--planning-page-controller.js" location="/js/kitchen-duty-plugin--planning-page-controller.js"/>
            |	<context>kitchen-duty-plugin</context>
            |</web-resource>
        ') }}

        <p>We have defined the resource now but JIRA does not know when to use (load) the resources we defined.
        <strong>We will use the PageBuilderService to tell JIRA when to load our resources</strong>.
            (You might want to try <code>#require</code> in your velocity templates instead, but PageBuilderService always worked best for me)</p>

        <p>We pull in some additional dependencies to be able to use PageBuilderService. Add these dependencies to your <code>pom.xml</code>.</p>


        {{ csSource(lang='xml', filename="pom.xml", ghBaseUrl=gitHubBaseUrlForStep3, source='
            |<dependency>
            |	<groupId>com.atlassian.templaterenderer</groupId>
            |	<artifactId>atlassian-template-renderer-api</artifactId>
            |	<version>1.5.7</version>
            |	<scope>provided</scope>
            |</dependency>
            |<dependency>
            |	<groupId>com.atlassian.plugins</groupId>
            |	<artifactId>atlassian-plugins-webresource</artifactId>
            |	<version>3.3.3</version>
            |	<scope>provided</scope>
            |</dependency>
        ') }}

        <p>We already learned that we need to do a <code>@ComponentImport</code> somewhere in our application to pull dependencies from other OSGi Bundles.
        That is why we simply do that in our <code>MyPluginComponentImpl.java</code> file which we will (mis)use for that purpose from now on.</p>

        {{ csSource(lang='java', filename="src/main/java/com/comsysto/kitchen/duty/impl/MyPluginComponentImpl.java", ghBaseUrl=gitHubBaseUrlForStep3, source='
            |import com.atlassian.webresource.api.assembler.PageBuilderService;
            |
            |...
            |
            |@ComponentImport
            |private PageBuilderService pageBuilderService;
        ') }}

        <p>Now that the PageBuilderService is usable we need to tell our Webwork Action to load our resources.</p>

        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filename="src/main/java/com/comsysto/kitchen/duty/webwork/KitchenDutyPlanningWebworkAction.java", ghBaseUrl=gitHubBaseUrlForStep3, uniqueId='h768go8gbo8gv8gbu909', source='
                    |package com.comsysto.kitchen.duty.webwork;
                    |
                    |import com.atlassian.webresource.api.assembler.PageBuilderService;
                    |import org.slf4j.Logger;
                    |import org.slf4j.LoggerFactory;
                    |import com.atlassian.jira.web.action.JiraWebActionSupport;
                    |
                    |import javax.inject.Inject;
                    |import javax.inject.Named;
                    |
                    |@Named {{{point::1}}}
                    |public class KitchenDutyPlanningWebworkAction extends JiraWebActionSupport
                    |{
                    |    private static final Logger log = LoggerFactory.getLogger(KitchenDutyPlanningWebworkAction.class);
                    |
                    |    @Inject {{{point::2}}}
                    |    private PageBuilderService pageBuilderService;
                    |
                    |    @Override
                    |    public String execute() throws Exception {
                    |        pageBuilderService.assembler().resources().requireWebResource(
                    |           "com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources" {{{point::3}}}
                    |        ).requireWebResource(
                    |           "com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources--planning-page"
                    |        );
                    |
                    |        return "kitchen-duty-planning-success";
                    |    }
                    |
                    |    public void setPageBuilderService(PageBuilderService pageBuilderService) { {{{point::4}}}
                    |        this.pageBuilderService = pageBuilderService;
                    |    }
                    |}
                ') }}
            </div>
            <div class="col-md-4">
                <div class="list-group cs-source-point-list" data-source-target="h768go8gbo8gv8gbu909">
                    <div class="list-group-item cs-source-point-list__item">
                        Define our <code>KitchenDutyPlanningWebworkAction</code> as <code>@Named</code>-component.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Use <code>@Inject</code> to wire the <code>PageBuilderService</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We tell the PageBuilderService via <code>requireWebResource()</code>
                        to load our shared resource bundle and our planning-page bundle containing the controller.
                        The pattern for require is <code>"pluginKey:resourceKey"</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        And of course a setter for the setter injection of PageBuilderService.
                    </div>
                </div>
            </div>
        </div>


        <p>After starting up JIRA via <code>atlas-run</code> (you should restart atlas-run because we added something to pom.xml) you
            <strong>should see a green success message popping up on the top right </strong> when
        surfing to planning page: <a class="cs-do-wrap" href="http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa">http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa</a></p>



        <div class="row">
            <div class="col-md-offset-2 col-md-8">
                <p>
                    <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-js-controller-working.gif" data-lightbox="03-step" data-title="Step 3 - Test of JS Controller for Planning Page">
                        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-js-controller-working.gif" class="img-thumbnail img-fluid" alt="Step 3 - Test of JS Controller for Planning Page">
                    </a>
                </p>
            </div>
        </div>

        <div class="cs-v-spacer cs-v-spacer--big"></div>

        <h3 class="cs-headline cs-headline--s">Setting up Select2 Widget to find Users</h3>

        <p>Before we start you might (not necessary) want to read in depth about <a href="https://docs.atlassian.com/aui/latest/docs/layout.html" target="_blank">AUI Layout</a>,
            <a href="https://docs.atlassian.com/aui/latest/docs/forms.html" target="_blank">AUI Forms</a> and <a href="https://developer.atlassian.com/confdev/tutorials/writing-soy-templates-in-your-plugin" target="_blank">Soy</a>.</p>

        <p>What is soy? It is a templating framework with templates we can use server-side and client-side. Cool! But we will need a transformer to transform the
        soy templates into JavaScript to be able to use them in our JS-Controller.</p>

        <p>Here is a short summary of what we will be doing now:</p>
        <ul>
            <li>Create a soy template for the user search.</li>
            <li>define a transformer to be able to use soy template in JS Controller.</li>
            <li>write some JS code to use <a href="https://docs.atlassian.com/aui/latest/docs/auiselect2.html" target="_blank">AUI Select2 widget</a> with our User Search REST Resource (see previous chapter).</li>
        </ul>

        <p>Create the soy template file in <code>src/main/resources/templates-soy/kitchen-duty-planning.soy</code> and paste the following code there.</p>
        <p>This file will later contain more than one template for each use case. But we will have one file per page.</p>


        {{ csSource(lang='soy', filename="src/main/resources/templates-soy/kitchen-duty-planning.soy", ghBaseUrl=gitHubBaseUrlForStep3, uniqueId='dsfhuzk656', source='
            |{namespace JIRA.Templates.KDP} {{{point::1}}}
            |/**
            | * Kitchen Duty Planning Page - User Search Template
            | */
            |{template .userSearch} {{{point::2}}}
            |<form class="aui" id="kdp-user-select-form"> {{{point::3}}}
            |
            |    <div class="field-group">
            |        <label for="kdp-user-select">Users</label>
            |        <div id="kdp-user-select"  {{{point::4}}}
            |                 name="kdp-user-select"
            |                 class="kdp-aui-select"
            |                 multiple=""
            |                 placeholder="start typing a username ...">
            |        </div>
            |        <div class="description">The users that should have kitchen duty.</div>
            |    </div>
            |    <div class="buttons-container">
            |        <div class="buttons">
            |            <input class="button submit" type="submit" {{{point::5}}}
            |                   id="kdp-user-select-save-button"
            |                   value="show"/>
            |        </div>
            |    </div>
            |
            |</form>
            |{/template}
        ') }}

        <p>Change velocity template so that we have one div container with an id we can use to dynamically insert our content which is rendered by JS-Controller.</p>

        {{ csSource(lang='html', filename="src/main/resources/templates/kitchen-duty-planning-webwork-module/kitchen-duty-planning-success.vm", ghBaseUrl=gitHubBaseUrlForStep3, uniqueId='h76sdfsgdfgodjfnsdfn909', source='
            |<html>
            |<head>
            |    <title>$i18n.getText("kitchen-duty-plugin.admin.planning.page.title")</title>
            |    <meta name="decorator" content="atl.admin">
            |</head>
            |<body>
            |<h1>$i18n.getText("kitchen-duty-plugin.admin.planning.page.headline")</h1>
            |
            |<div id="kdp-planning-page-container"></div> {{{point::1}}}
            |
            |</body>
            |</html>
        ') }}

        <p>Change the JS-Controller to render the soy template, initialize the AUI Select 2 widget to work with our User Search REST Resource.</p>

        {{ csSource(lang='js', filename="src/main/resources/js/kitchen-duty-plugin--planning-page-controller.js", ghBaseUrl=gitHubBaseUrlForStep3, uniqueId='iusndf98sidjcn', source="
            |var showSuccessFlag = function(message) {
            |    require(['aui/flag'], function(flag) {
            |        var myFlag = flag({
            |            type: 'success',
            |            title: 'Kitchen Duty Plugin',
            |            close: 'auto',
            |            body: message
            |        });
            |    });
            |};
            |
            |var initUserSearch = function(restUrl) {
            |    var templateUserSearch = JIRA.Templates.KDP.userSearch();
            |
            |    var auiUserSelectOptions = {
            |        ajax: {
            |            url: function () {
            |                return restUrl + '/user/search';
            |            },
            |            dataType: 'json',
            |            delay: 250,
            |            data: function (searchTerm) {
            |                return {
            |                    query: searchTerm
            |                };
            |            },
            |            results: function (data) {
            |                return {
            |                    results: data
            |                };
            |            },
            |            cache: true
            |        },
            |        minimumInputLength: 1,
            |        tags: 'true'
            |    };
            |
            |    /* INIT TEMPLATES AND WIDGETS */
            |
            |    AJS.$('#kdp-planning-page-container').append(templateUserSearch);
            |    AJS.$('#kdp-user-select').auiSelect2(auiUserSelectOptions);
            |    AJS.$('#kdp-user-select-form').submit(function (e) {
            |        e.preventDefault();
            |        AJS.$(AJS.$('#kdp-user-select').select2('data')).each(function () {
            |            showSuccessFlag(this.id);
            |        });
            |    });
            |};
            |
            |AJS.toInit(function(){
            |    AJS.log('KDP: Planning Page Controller initializing ...');
            |    var baseUrl = AJS.params.baseURL;
            |    var restUrl = baseUrl + '/rest/kitchenduty/1.0';
            |
            |    initUserSearch(restUrl);
            |});
            ") }}

        <p>Now we need to teach JIRA that we want to use soy in our client-side code and define a transformer and the soy template to load. Also we need to define AUI dependencies to be loaded.</p>

        {{ csSource(lang='xml', filename="src/main/resources/atlassian-plugin.xml", ghBaseUrl=gitHubBaseUrlForStep3, uniqueId='difjn9sufpoj', source='
            |<?xml version="1.0" encoding="UTF-8"?>
            |
            |<atlassian-plugin key="${atlassian.plugin.key}" name="${project.name}" plugins-version="2">
            |...
            |  <web-resource key="kitchen-duty-plugin-resources--planning-page" name="kitchen-duty-plugin Web Resources for Planning Page">
            |    <dependency>com.atlassian.auiplugin:ajs</dependency>
            |    <dependency>com.atlassian.auiplugin:aui-select2</dependency> {{{point::1}}}
            |    <dependency>com.atlassian.auiplugin:aui-experimental-soy-templates</dependency> {{{point::2}}}
            |    <transformation extension="soy"> {{{point::3}}}
            |      <transformer key="soyTransformer">
            |        <functions>com.atlassian.confluence.plugins.soy:soy-core-functions</functions>
            |      </transformer>
            |    </transformation>
            |    <resource type="download" name="kitchen-duty-planning-soy.js" {{{point::4}}}
            |              location="templates-soy/kitchen-duty-planning.soy"/>
            |    <resource type="download" name="kitchen-duty-plugin--planning-page-controller.js"
            |              location="/js/kitchen-duty-plugin--planning-page-controller.js"/>
            |    <context>kitchen-duty-plugin</context>
            |  </web-resource>
            |...
            |</atlassian-plugin>
        ') }}

        <p>Now restart <code>atlas-run</code> and refresh (shift-reload) the Page and you should see this:</p>

        <div class="row">
            <div class="col-md-offset-2 col-md-8">
                <p>
                    <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-user-search-select2.gif" data-lightbox="03-step" data-title="Step 3 - User Search working with AUI select2 widget and soy Template">
                        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-03-user-search-select2.gif" class="img-thumbnail img-fluid" alt="Step 3 - User Search working with AUI select2 widget and soy Template">
                    </a>
                </p>
            </div>
        </div>

        <div class="cs-v-spacer cs-v-spacer--big"></div>




        {# TODO: FURTHER READING

                            <h3 class="cs-headline cs-headline--s">Further Reading: Develop Faster</h3>

                            <p>SHOW: how to use atlas-cli and PI command to develop faster.</p>

                            <p>SHOW: Velocity template caching</p>
        #}

        {#
        <p>TODO: atlas-create-home-zip => predefined users</p>

        #}

        <div class="cs-v-spacer cs-v-spacer--big"></div>
        <div class="cs-v-spacer cs-v-spacer--big"></div>






        <div class="cs-v-spacer"></div>
        <div class="cs-tutorial-step-review">
            <div class="cs-tutorial-step-review__headline">
                <strong>You have completed Step 3.</strong> Good Job! You can check out this steps solution on GitHub
            </div>
            <div class="cs-tutorial-step-review__link">
                <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-03-kitchen-duty-plugin">
                    https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-03-kitchen-duty-plugin
                </a>
            </div>
        </div>

        <div class="cs-v-spacer"></div>
        <p>The graphic shows marked green <strong>which components we implemented in this section</strong>.</p>
        <script>
            var dummyClickCallback = function() {
                toastr.warning('dummy callback', 'Awesome!')
            };
        </script>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-10 col-lg-offset-1 col-xl-8 col-xl-offset-2">
                {{ interactiveGraphic('p06-ig01', 'kitchen-duty-planning-page--component-overview',
                '{
                    "markedAsDone": [ "webwork-action", "html-view", "user-resource", "user-search-resource-model", "user-js-controller" ],
                    "markedAsTodo": [ ],
                    "markedAsGrayedOut": [ ],
                    "onClick": [ { "webwork-action": "dummyClickCallback" } ]
                }')
                }}
            </div>
        </div>

        <div class="cs-v-spacer cs-v-spacer--big"></div>
        <div class="cs-v-spacer cs-v-spacer--big"></div>

    </div>
</div>


{% endblock %}
