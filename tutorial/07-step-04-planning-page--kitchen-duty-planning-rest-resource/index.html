<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    
    <title>Kitchen Duty Planning REST Resource ~ Planning Page | Plugin Development Tutorial for Atlassian JIRA® | Kitchen Duty Plugin by comSysto</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by comSysto">
    <meta name="robots" content="noindex, nofollow">


    
    <meta property="og:title" content="Kitchen Duty Plugin for Atlassian JIRA® by comSysto" />
    <meta property="og:image" content="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/images/kitchen-duty-plugin--social.jpg" />
    <meta property="og:description" content="An interactive tutorial on how to write Plugins for Atlassian JIRA® by comSysto" />

    
    <link rel="canonical" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/tutorial/07-step-04-planning-page--kitchen-duty-planning-rest-resource/" />

    <link rel="alternate" type="application/rss+xml" title="Kitchen Duty Plugin News" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/rss_feed.xml" />



    <link href="/kitchen-duty-plugin-for-atlassian-jira/generated/bundle.css" rel="stylesheet">

    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-256.png" type="image/png" sizes="256x256">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon.svg" type="image/svg+xml">

    <script>var postLoadMethods = [];</script>
</head>
<body class="cs-tutorial-body">























<div class="container-fluid cs-page-header">
    <div class="row">
        <div class="col-md-5 cs-page-header--left-fix">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/" class="cs-page-logo">
                <span class="cs-page-logo-img hidden-md-down"></span>
                <h1>Kitchen Duty Plugin</h1>
                <h2>for Atlassian JIRA® by comSysto</h2>
            </a>
        </div>
        <div class="col-md-3 text-xs-center hidden-sm-down">
            <a class="btn btn-primary cs-stars-on-github-give-star-button" href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira" target="_blank">
                <span class="cs-stars-on-github-count-stars"></span>
                <i class="fa fa-star"></i>
                <span class="cs-stars-on-github-right hidden-md-down">Star on GitHub</span>
            </a>

            <a class="btn btn-primary" href="/kitchen-duty-plugin-for-atlassian-jira/news/" target="_blank">
                <span class="cs-news-right">news</span>
            </a>
        </div>
        <div class="col-md-4  hidden-sm-down cs-page-header-cs-logo text-xs-right cs-page-header--right-fix">
            <a href="https://comsysto.com/leistungen/atlassian-experts-services" target="_blank"><img src="/kitchen-duty-plugin-for-atlassian-jira/images/comsysto-logo.png" alt="comSysto"/></a>
        </div>
    </div>

</div>

<!-- CONTENT -->



<div class="cs-sidebar-wrapper hidden-md-down">
    
<div id="toc">
    <ul>

        

        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/01-introduction/">
        Introduction
    </a>
        </li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/02-step-00-getting-started/">
        <span class="cs-step-badge pull-right">0</span>
        Getting Started
    </a>
        </li>

        

        <li class="toc-h2-divider">Part I: Kitchen Duty Planning Page</li>

        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">
        Story Workshop for Planning Page
    </a>
        </li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/04-step-01-planning-page--webwork-action-and-html-view/">
        <span class="cs-step-badge pull-right">1</span>
        Webwork Action and HTML View
    </a>
        </li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/05-step-02-planning-page--user-search-rest-resource/">
        <span class="cs-step-badge pull-right">2</span>
        User Search REST Resource
    </a>
        </li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/06-step-03-planning-page--user-search-js-controller/">
        <span class="cs-step-badge pull-right">3</span>
        User Search JS Controller
    </a>
        </li>
        <li class="toc-h2 toc-active"><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/07-step-04-planning-page--kitchen-duty-planning-rest-resource/">
        <span class="cs-step-badge pull-right">4</span>
        Kitchen Duty Planning REST Resource
    </a>
        </li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/08-step-05-planning-page--kitchen-duty-planning-js-controller/">
        <span class="cs-step-badge pull-right">5</span>
        Kitchen Duty Planning JS Controller
    </a>
        </li>
        
        <li>
            
            
            
            
            
            
            
            
            <p>&nbsp;</p>
            <div class="cs-toc-infographic-wrapper">
                
<svg class="cs-interactive-graphic"
     id="navSvg11"
     data-json-settings="{
            &quot;markedAsDone&quot;: [ &quot;webwork-action&quot;, &quot;html-view&quot;, &quot;user-resource&quot;, &quot;user-search-resource-model&quot;, &quot;user-js-controller&quot; ],
            &quot;markedAsTodo&quot;: [ &quot;kitchen-duty-resource&quot;, &quot;kitchen-duty-planning-model&quot; ],
            &quot;markedAsGrayedOut&quot;: [ ],
            &quot;onClick&quot;: [ ]
            }"
     data-svg-to-load="kitchen-duty-planning-page--component-overview"
     viewBox="0 0 1043 654"
     preserveAspectRatio="xMaxYMax">
</svg>

            </div>
        </li>
        

        

        <li class="toc-h2-divider">Part II: Kitchen Duty Overview Page</li>
        <li class="toc-h2 "><a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/09-story-workshop-for-overview-page/">
        Story Workshop for Overview Page
    </a>
        </li>
    </ul>




</div>


</div>

<div class="cs-content-wrapper">
    



<div class="row">
    <div class="col-md-12">
        




<h2 class="cs-headline cs-headline--m cs-headline--anchor"
    data-scroll-to-headline="kitchen-duty-planning-rest-resource"
    data-scroll-to-headline-previous="">
    
    Kitchen Duty Planning REST Resource
</h2>


        
        
        

        <p>Basically we will build the <strong>Kitchen Duty Planning REST Resource</strong> and the <strong>Kitchen Duty Planning REST Model</strong>
            which will persist our selected weeks and users to the database.</p>

        <p>You also might want to look into <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">the Story Workshop</a> again to recapitulate what we are going to build now.</p>

        <div class="alert alert-info">This chapter heavily depends on the <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/05-step-02-planning-page--user-search-rest-resource/">configuration done in Step 2</a>.</div>

        <h3 class="cs-headline cs-headline--s">What do we need exactly?</h3>

        <div class="row">
            <div class="col-md-6">
                <p>
                    After some serious brain usage on how to store the actual data of <strong>&laquo;who has Kitchen Duty in which week?&raquo;</strong>
                    I came up with the <strong>Data-Model</strong> seen on the right.</p>
                <p>
                    The <strong>Week</strong> will be the actual week number in the year, and we don't care about the year in this tutorial. So if you had kitchen duty in week 24 this year you will have it the years after as well.
                    With a little thinking ahead of how I want to use it in the JS Controller
                    I basically will select a week via a date picker and <a href="http://momentjs.com/docs/#/get-set/iso-week/">calculate the isoWeek in the frontend using moment.js</a></p>
                <p>
                    The <strong>User</strong> part is obvious. We will need to store a list of usernames in the database in relation with Weeks (<a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/manytomany-relationship"><code>@ManyToMany</code></a>).
                </p>
                <p>
                    Concerning the <strong>REST Endpoint</strong> I will want to have an URL which I can fire
                    GET requests on something like <code>/planning/week/15/users</code> and receive a list of users.
                </p>
                <p>
                    Obviously the other way round would be a PUT request on <code>/planning/week/15/users</code> with a list of users
                    as request body to store the user list for the week 15.
                </p>

                <p>
                    And for our stretch-goal a GET request on <code>/planning/user/bob/weeks</code> should return a list of week numbers
                    in which Bob has Kitchen Duty.
                </p>
            </div>
            <div class="col-md-offset-1 col-md-5">
                <table class="table table-bordered cs-table-uml">
                    <thead>
                    <tr>
                        <th>Week</th>
                        <th class="cs-table-uml--connector">
                            n&nbsp;&nbsp;&nbsp;&nbsp;m
                        </th>
                        <th>User</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>isoWeek:&nbsp;Integer</td>
                        <td class="cs-table-uml--blank"></td>
                        <td>username:&nbsp;String</td>
                    </tr>
                    </tbody>
                </table>
                <br>
                <br>
                <div style="padding:0 30px 0 30px">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/persist-me-senpai.jpg" class="img-fluid" style="max-width:400px">
                </div>
            </div>
        </div>

        <h3 class="cs-headline cs-headline--s">How exactly do we persist our data?</h3>


        <p>Alright we know how we want to use our REST Endpoint from the perspective of the JS Controller. And we have some kind of clue
            on how the data should be stored theoretically.</p>

        <p>There are <strong>two main possibilities to persist data in JIRA</strong>.</p>

        <p>
            <ul>
                <li>
                    Using the <strong><a href="https://developer.atlassian.com/docs/common-coding-tasks/storing-plugin-settings">PluginSettingsFactory</a></strong> you
                    have an easy way to persist data. But you don't have queries and cannot build relationships like you can with a real Database.
                    So this is good if you just want to store simple stuff when you always know how to retrieve data from the PluginSettingsFactory (for example by a fixed key).
                    <br />&nbsp;
                </li>
                <li>
                    Then there are <strong><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects">Active Objects</a></strong> which let you use
                    a real database with an ORM Interface. And that is definitely the choice we want to make here.
                    So you might want to stroll around the Active Objects documents a little to get a grasp of it or just continue reading since I will also introduce you to it step by step.
                </li>
            </ul>
        </p>


        <h3 class="cs-headline cs-headline--s">Enabling Active Objects on our Project</h3>

        <p>
            All I will be writing about Active Objects is taken from the <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects">Developing your plugin with Active Objects Guide</a></em> and the <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/getting-started-with-active-objects">Getting Started with Active Objects Guide</a></em>.
        </p>

        <p>
            First of all add <a href="https://maven.atlassian.com/content/repositories/atlassian-public/com/atlassian/activeobjects/activeobjects-plugin/">Active Objects dependency</a> to your pom.xml.
        </p>

        

<div class="cs-code-filename">
    
    pom.xml
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-04-kitchen-duty-plugin/pom.xml" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="&lt;dependency&gt;
   &lt;groupId&gt;com.atlassian.activeobjects&lt;/groupId&gt;
   &lt;artifactId&gt;activeobjects-plugin&lt;/artifactId&gt;
   &lt;version&gt;1.1.5&lt;/version&gt;
   &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.atlassian.activeobjects<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>activeobjects-plugin<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.1.5<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-title">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-title">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span></code></pre>




        <p>We need a <strong>Component Import for <code>ActiveObjects</code></strong> which will be the object we use to access the database.</p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/impl/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/impl/">.../</span>MyPluginComponentImpl.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/impl/MyPluginComponentImpl.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import com.atlassian.activeobjects.external.ActiveObjects;
import com.atlassian.plugin.spring.scanner.annotation.imports.ComponentImport;
...

@Named (&quot;myPluginComponent&quot;)
public class MyPluginComponentImpl implements MyPluginComponent {
   ...
   @ComponentImport
   private ActiveObjects activeObjects;
   ...
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> com.atlassian.activeobjects.external.ActiveObjects;
<span class="hljs-keyword">import</span> com.atlassian.plugin.spring.scanner.annotation.imports.ComponentImport;
...

<span class="hljs-annotation">@Named</span> (<span class="hljs-string">"myPluginComponent"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPluginComponentImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MyPluginComponent</span> </span>{
   ...
   <span class="hljs-annotation">@ComponentImport</span>
   <span class="hljs-keyword">private</span> ActiveObjects activeObjects;
   ...
}</code></pre>

        </p>

        <p>Now we <strong>create our first Entity <code>Week</code></strong> and define the week as integer via getter/setter.</p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>Week.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/Week.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

import net.java.ao.Entity;
import net.java.ao.Preload;

@Preload
public interface Week extends Entity {
    Integer getWeek();

    void setWeek(Integer week);
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

<span class="hljs-keyword">import</span> net.java.ao.Entity;
<span class="hljs-keyword">import</span> net.java.ao.Preload;

<span class="hljs-annotation">@Preload</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Week</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span> </span>{
    <span class="hljs-function">Integer <span class="hljs-title">getWeek</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setWeek</span><span class="hljs-params">(Integer week)</span></span>;
}</code></pre>

        </p>


        <p>23 xxNow we need to add a section to our atlassian-plugin.xml file listing all our Entity classes which we will create.</p>


        

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/resources/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/">.../</span>atlassian-plugin.xml
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d/step-04-kitchen-duty-plugin/src/main/resources/atlassian-plugin.xml" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="&lt;ao key=&quot;ao-module&quot;&gt;
    &lt;description&gt;The module configuring the Active Objects service used by this plugin&lt;/description&gt;
    &lt;entity&gt;com.comsysto.kitchen.duty.ao.Week&lt;/entity&gt;
&lt;/ao&gt;"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">ao</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"ao-module"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">description</span>&gt;</span>The module configuring the Active Objects service used by this plugin<span class="hljs-tag">&lt;/<span class="hljs-title">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">entity</span>&gt;</span>com.comsysto.kitchen.duty.ao.Week<span class="hljs-tag">&lt;/<span class="hljs-title">entity</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">ao</span>&gt;</span></code></pre>



        <h3 class="cs-headline cs-headline--s">Creating a basic Week Entity and a persist-Endpoint</h3>

        <p>We will create the Kitchen Duty Planning REST Resource which will interact with the JS Controller to load and store the Kitchen Duty Planning REST Model.</p>

        <p>Alright we now create the <strong>persistTest</strong> Endpoint to persist Week Objects to test our Active Objects Setup.
        Therefore we also Inject the ActiveObjects Object via the Constructor. </p>

        

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import com.atlassian.activeobjects.external.ActiveObjects;
import com.atlassian.jira.bc.user.search.UserSearchService;
import com.atlassian.plugins.rest.common.security.AnonymousAllowed;
import com.atlassian.sal.api.transaction.TransactionCallback;
import com.comsysto.kitchen.duty.ao.Week;

import javax.inject.Inject;
import javax.inject.Named;
import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.ArrayList;
import java.util.List;

@Named
@Path(&quot;/planning&quot;)
public class KitchenDutyPlanningResource {

    private ActiveObjects activeObjects;

    @Inject
    public KitchenDutyPlanningResource(ActiveObjects activeObjects) {
        this.activeObjects = activeObjects;
    }

    public KitchenDutyPlanningResource() {
    }


    @GET
    @Path(&quot;/persistTest&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response persistTest() {
        activeObjects.executeInTransaction(new TransactionCallback&lt;Week&gt;()
        {
            @Override
            public Week doInTransaction()
            {
                final Week testWeek = activeObjects.create(Week.class);
                testWeek.setWeek(42);
                testWeek.save();
                return testWeek;
            }
        });
        return Response.ok(&quot;ok&quot;).build();
    }


    @GET
    @Path(&quot;/health&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response health() {
        return Response.ok(&quot;ok&quot;).build();
    }

}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> com.atlassian.activeobjects.external.ActiveObjects;
<span class="hljs-keyword">import</span> com.atlassian.jira.bc.user.search.UserSearchService;
<span class="hljs-keyword">import</span> com.atlassian.plugins.rest.common.security.AnonymousAllowed;
<span class="hljs-keyword">import</span> com.atlassian.sal.api.transaction.TransactionCallback;
<span class="hljs-keyword">import</span> com.comsysto.kitchen.duty.ao.Week;

<span class="hljs-keyword">import</span> javax.inject.Inject;
<span class="hljs-keyword">import</span> javax.inject.Named;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.ws.rs.GET;
<span class="hljs-keyword">import</span> javax.ws.rs.Path;
<span class="hljs-keyword">import</span> javax.ws.rs.Produces;
<span class="hljs-keyword">import</span> javax.ws.rs.QueryParam;
<span class="hljs-keyword">import</span> javax.ws.rs.core.Context;
<span class="hljs-keyword">import</span> javax.ws.rs.core.MediaType;
<span class="hljs-keyword">import</span> javax.ws.rs.core.Response;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/planning"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResource</span> </span>{

    <span class="hljs-keyword">private</span> ActiveObjects activeObjects;

    <span class="hljs-annotation">@Inject</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyPlanningResource</span><span class="hljs-params">(ActiveObjects activeObjects)</span> </span>{
        <span class="hljs-keyword">this</span>.activeObjects = activeObjects;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyPlanningResource</span><span class="hljs-params">()</span> </span>{
    }


    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/persistTest"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">persistTest</span><span class="hljs-params">()</span> </span>{
        activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Week&gt;()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Week <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span>
            </span>{
                <span class="hljs-keyword">final</span> Week testWeek = activeObjects.create(Week.class);
                testWeek.setWeek(<span class="hljs-number">42</span>);
                testWeek.save();
                <span class="hljs-keyword">return</span> testWeek;
            }
        });
        <span class="hljs-keyword">return</span> Response.ok(<span class="hljs-string">"ok"</span>).build();
    }


    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/health"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">health</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> Response.ok(<span class="hljs-string">"ok"</span>).build();
    }

}</code></pre>




        <p>Login to JIRA and then open this URL: <a href="http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest">http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest</a></p>

        <p>The URL should return 'ok' and in the background our week object got persisted to the database.</p>


        <p>We will <strong>look into the H2 Database now</strong>. Therefore we need to:</p>

        <p>(1) Stop JIRA via killing the atlas-run process</p>
        <p>(2) Connect to the built in H2 Database (yes H2 and not HSQLDB!)</p>
        <p>(2.1) Go into the project Dir where you just killed atlas-run and execute the h2.jar to open the H2 console (a browser Tab opens)</p>
        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="java -jar target/container/tomcat8x/cargo-jira-home/webapps/jira/WEB-INF/lib/h2-1.4.185.jar"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        java -jar target/container/tomcat8x/cargo-jira-home/webapps/jira/WEB-INF/lib/h2-1.4.185.jar<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs"></code></pre>

    </div>
</div>


        <p>(2.2) Now you must search the output of atlas-run (at best grep it) and look for 'Database URL'</p>
        <code>[INFO] [talledLocalContainer]          Database URL                                  : jdbc:h2:file:/Users/clouless/git/kitchen-duty-plugin-for-atlassian-jira/step-04-kitchen-duty-plugin/target/jira/home/database/h2db</code>
        <p>(2.3) COnnect the console to the JIRA H2 Database URL. In my case <code>jdbc:h2:file:/Users/clouless/git/kitchen-duty-plugin-for-atlassian-jira/step-04-kitchen-duty-plugin/target/jira/home/database/h2db</code></p>

        <p>(3) Look for our Week table. It will be named <code>AO_hash_WEEK</code> and do a query for the entries</p>



        <div class="cs-blockquote">
            <p>
                Please remember to always just look into the database.
                You should never alter the Database with SQL Statements since JIRA manages autoincrement IDs and some other Caches
                and you will surely run into strange errors if you still do so.<br/>
                <strong>Number One Rule: Only alter the Database through Active Objects.</strong>
            </p>
        </div>


        <p>You should see this</p>

        <!--
        [INFO] [talledLocalContainer] INFORMATION: Server startup in 38377 ms
        [INFO] [talledLocalContainer] Tomcat 8.x started on port [2990]
        [INFO] jira started successfully in 58s at http://localhost:2990/jira
        [INFO] Type Ctrl-D to shutdown gracefully
        [INFO] Type Ctrl-C to exit
        -->

        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-04-h2-console-jira.png" class="img-fluid" style="width:60%;margin-left:20%;margin-bottom:30px;margin-top:30px;">

        <p>You can see the whole process in the gif:</p>

        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-04-h2-jira-connect.gif" class="img-fluid" style="width:60%;margin-left:20%;margin-bottom:30px;margin-top:30px;border:1px solid #ccc;">





        <h3 class="cs-headline cs-headline--s">Adding User Class and Many-to-Many Relationship</h3>

        <p>Since we got Active Objects running successfully we now want to add a <a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/manytomany-relationship"><code>@ManyToMany</code></a> relationship between <code>User</code> an <code>Week</code>.</p>
        <p>And when you have read the docs you will note that we need a Mapping Entity for that case. We will call it <code>UserToWeek</code>.</p>

        <p>Do a <code>atlas-clean</code> before the next <code>atlas-run</code> so that the database gets purged. Otherwise you might run into <code> Unique index or primary key violation</code> errors since we have 4 week entries already all with week 42 values.</p>



        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>Week.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/3b102ae23eaa587bb432b4b04b806ff78eb50b8f/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/Week.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

import net.java.ao.Entity;
import net.java.ao.ManyToMany;
import net.java.ao.Preload;
import net.java.ao.schema.NotNull;
import net.java.ao.schema.Unique;

@Preload
public interface Week extends Entity {

    @NotNull
    @Unique
    Integer getWeek();
    void setWeek(Integer week);

    @ManyToMany(value = UserToWeek.class)
    User[] getUsers();
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

<span class="hljs-keyword">import</span> net.java.ao.Entity;
<span class="hljs-keyword">import</span> net.java.ao.ManyToMany;
<span class="hljs-keyword">import</span> net.java.ao.Preload;
<span class="hljs-keyword">import</span> net.java.ao.schema.NotNull;
<span class="hljs-keyword">import</span> net.java.ao.schema.Unique;

<span class="hljs-annotation">@Preload</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Week</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span> </span>{

    <span class="hljs-annotation">@NotNull</span>
    <span class="hljs-annotation">@Unique</span>
    <span class="hljs-function">Integer <span class="hljs-title">getWeek</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setWeek</span><span class="hljs-params">(Integer week)</span></span>;

    <span class="hljs-annotation">@ManyToMany</span>(value = UserToWeek.class)
    User[] getUsers();
}</code></pre>

        </p>


        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>User.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/3b102ae23eaa587bb432b4b04b806ff78eb50b8f/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/User.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

import net.java.ao.Entity;
import net.java.ao.ManyToMany;
import net.java.ao.Preload;
import net.java.ao.schema.NotNull;
import net.java.ao.schema.Unique;

@Preload
public interface User extends Entity {

    @NotNull
    @Unique
    String getName();
    void setName(String week);

    @ManyToMany(value = UserToWeek.class)
    Week[] getWeeks();
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

<span class="hljs-keyword">import</span> net.java.ao.Entity;
<span class="hljs-keyword">import</span> net.java.ao.ManyToMany;
<span class="hljs-keyword">import</span> net.java.ao.Preload;
<span class="hljs-keyword">import</span> net.java.ao.schema.NotNull;
<span class="hljs-keyword">import</span> net.java.ao.schema.Unique;

<span class="hljs-annotation">@Preload</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span> </span>{

    <span class="hljs-annotation">@NotNull</span>
    <span class="hljs-annotation">@Unique</span>
    <span class="hljs-function">String <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String week)</span></span>;

    <span class="hljs-annotation">@ManyToMany</span>(value = UserToWeek.class)
    Week[] getWeeks();
}</code></pre>

        </p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>UserToWeek.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/3b102ae23eaa587bb432b4b04b806ff78eb50b8f/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/UserToWeek.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

import net.java.ao.Entity;

public interface UserToWeek extends Entity {

    void setUser(User user);
    User getUser();

    void setWeek(Week week);
    Week getWeek();
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

<span class="hljs-keyword">import</span> net.java.ao.Entity;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserToWeek</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setUser</span><span class="hljs-params">(User user)</span></span>;
    <span class="hljs-function">User <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setWeek</span><span class="hljs-params">(Week week)</span></span>;
    <span class="hljs-function">Week <span class="hljs-title">getWeek</span><span class="hljs-params">()</span></span>;
}</code></pre>

        </p>

        

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/resources/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/">.../</span>atlassian-plugin.xml
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/3b102ae23eaa587bb432b4b04b806ff78eb50b8f/step-04-kitchen-duty-plugin/src/main/resources/atlassian-plugin.xml" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="&lt;ao key=&quot;ao-module&quot;&gt;
    &lt;description&gt;The module configuring the Active Objects service used by this plugin&lt;/description&gt;
    &lt;entity&gt;com.comsysto.kitchen.duty.ao.Week&lt;/entity&gt;
    &lt;entity&gt;com.comsysto.kitchen.duty.ao.User&lt;/entity&gt;
    &lt;entity&gt;com.comsysto.kitchen.duty.ao.UserToWeek&lt;/entity&gt;
&lt;/ao&gt;"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">ao</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"ao-module"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">description</span>&gt;</span>The module configuring the Active Objects service used by this plugin<span class="hljs-tag">&lt;/<span class="hljs-title">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">entity</span>&gt;</span>com.comsysto.kitchen.duty.ao.Week<span class="hljs-tag">&lt;/<span class="hljs-title">entity</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">entity</span>&gt;</span>com.comsysto.kitchen.duty.ao.User<span class="hljs-tag">&lt;/<span class="hljs-title">entity</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">entity</span>&gt;</span>com.comsysto.kitchen.duty.ao.UserToWeek<span class="hljs-tag">&lt;/<span class="hljs-title">entity</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">ao</span>&gt;</span></code></pre>




        <p>We defined the Week and the User as <code>@Unique</code> and <code>@NotNull</code> therefore we need to create
            the Object with DBParams. See <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/creating-entities">'Creating an entity with "not null"-constraints'</a> in the docs.</em>
            Therefore we <strong>change the testPersist Endpoint to now persist a full relationship and handle the not-null thingy by DBParams.</strong>
        </p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/83e18b1e57beb1e9282b2b3781966f88efd2763f/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;
...

@Named
@Path(&quot;/planning&quot;)
public class KitchenDutyPlanningResource {
...

    @GET
    @Path(&quot;/persistTest&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response persistTest() {
        activeObjects.executeInTransaction(new TransactionCallback&lt;Week&gt;()
        {
            @Override
            public Week doInTransaction()
            {
                final Week testWeek = activeObjects.create(
                    Week.class,
                    new DBParam(&quot;WEEK&quot;, 42));
                testWeek.save();

                final User user = activeObjects.create(
                    User.class,
                    new DBParam(&quot;NAME&quot;, &quot;ichiban&quot;));
                user.save();

                final UserToWeek relationship = activeObjects.create(UserToWeek.class);
                relationship.setUser(user);
                relationship.setWeek(testWeek);
                relationship.save();

                return testWeek;
            }
        });
        return Response.ok(&quot;ok&quot;).build();
    }
...
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;
...

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/planning"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResource</span> </span>{
...

    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/persistTest"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">persistTest</span><span class="hljs-params">()</span> </span>{
        activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Week&gt;()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Week <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span>
            </span>{
                <span class="hljs-keyword">final</span> Week testWeek = activeObjects.create(
                    Week.class,
                    <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"WEEK"</span>, <span class="hljs-number">42</span>));
                testWeek.save();

                <span class="hljs-keyword">final</span> User user = activeObjects.create(
                    User.class,
                    <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"NAME"</span>, <span class="hljs-string">"ichiban"</span>));
                user.save();

                <span class="hljs-keyword">final</span> UserToWeek relationship = activeObjects.create(UserToWeek.class);
                relationship.setUser(user);
                relationship.setWeek(testWeek);
                relationship.save();

                <span class="hljs-keyword">return</span> testWeek;
            }
        });
        <span class="hljs-keyword">return</span> Response.ok(<span class="hljs-string">"ok"</span>).build();
    }
...
}</code></pre>

        </p>


        <p>We use <code>new DBParam("WEEK", 42));</code> in the <strong>activeObjects#create</strong> Method to prevent a not-null exception.</p>

        <p>
            We startup JIRA again and call the <a href="http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest">http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest</a> Endpoint again after logging in.
        </p>
        <p>
            And by calling the testPersist endpoint a second time we will get a <strong>unique constraint exception</strong>.
            But that is fine since that only show that the unique constraint works and we will be throwing away the persistTest Endpoint anyways.
        </p>

        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-04-unique-index-exception.png" class="img-fluid" style="width:60%;margin-left:20%;margin-bottom:30px;margin-top:30px;">



        <p>We shutdown JIRA again and fire up the H2 Console again to see what Tables have been created</p>

        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-04-many-to-many-week-user.png" class="img-fluid" style="width:60%;margin-left:20%;margin-bottom:30px;margin-top:30px;">








        <h3 class="cs-headline cs-headline--s">Creating the real Kitchen Duty Planning REST Resource</h3>

        <p>
            Ok we have played around a little with active objects in the previous sections and now have our full
            data model and entities in place. That means we can now create the real Endpoint Methods and throw away the testPersist Endpoint.
        </p>




        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/e923ee619b945042bc37217e78b3aead2f8a4b44/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;
...

@Named
@Path(&quot;/planning&quot;)
public class KitchenDutyPlanningResource {
...

    /**
     * Get the Users assigned to the isoWeekNumber.
     *
     * @param isoWeekNumber
     * @return
     */
    @GET
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response persistTest(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber) {
        Week[] weeks = activeObjects.executeInTransaction(new TransactionCallback&lt;Week[]&gt;() {
            @Override
            public Week[] doInTransaction() {
                return activeObjects.find(Week.class, Query.select().where(&quot;WEEK = ?&quot;, isoWeekNumber));
            }
        });
        List&lt;KitchenDutyPlanningResourceUserModel&gt; users = new ArrayList&lt;&gt;();
        if (weeks != null &amp;&amp; weeks.length &gt; 0) {
            for (User user : weeks[0].getUsers()) {
                users.add(new KitchenDutyPlanningResourceUserModel(user.getID(), user.getName()));
            }
        }
        return Response.ok(users).build();
    }

    /**
     * Get the Weeks assigned to the User.
     *
     * @param isoWeekNumber
     * @return
     */
    @GET
    @Path(&quot;/user/{username}/weeks&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response persistTest(@PathParam(&quot;username&quot;) final String username) {
        User[] users = activeObjects.executeInTransaction(new TransactionCallback&lt;User[]&gt;() {
            @Override
            public User[] doInTransaction() {
                return activeObjects.find(User.class, Query.select().where(&quot;NAME = ?&quot;, username));
            }
        });
        List&lt;KitchenDutyPlanningResourceWeekModel&gt; weeks = new ArrayList&lt;&gt;();
        if (users != null &amp;&amp; users.length &gt; 0) {
            for (Week week : users[0].getWeeks()) {
                weeks.add(new KitchenDutyPlanningResourceWeekModel(week.getID(), week.getWeek()));
            }
        }
        return Response.ok(weeks).build();
    }
...
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;
...

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/planning"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResource</span> </span>{
...

    <span class="hljs-comment">/**
     * Get the Users assigned to the isoWeekNumber.
     *
     * <span class="hljs-doctag">@param</span> isoWeekNumber
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">persistTest</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber) </span>{
        Week[] weeks = activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Week[]&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> Week[] doInTransaction() {
                <span class="hljs-keyword">return</span> activeObjects.find(Week.class, Query.select().where(<span class="hljs-string">"WEEK = ?"</span>, isoWeekNumber));
            }
        });
        List&lt;KitchenDutyPlanningResourceUserModel&gt; users = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">if</span> (weeks != <span class="hljs-keyword">null</span> &amp;&amp; weeks.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (User user : weeks[<span class="hljs-number">0</span>].getUsers()) {
                users.add(<span class="hljs-keyword">new</span> KitchenDutyPlanningResourceUserModel(user.getID(), user.getName()));
            }
        }
        <span class="hljs-keyword">return</span> Response.ok(users).build();
    }

    <span class="hljs-comment">/**
     * Get the Weeks assigned to the User.
     *
     * <span class="hljs-doctag">@param</span> isoWeekNumber
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/user/{username}/weeks"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">persistTest</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"username"</span>)</span> <span class="hljs-keyword">final</span> String username) </span>{
        User[] users = activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;User[]&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> User[] doInTransaction() {
                <span class="hljs-keyword">return</span> activeObjects.find(User.class, Query.select().where(<span class="hljs-string">"NAME = ?"</span>, username));
            }
        });
        List&lt;KitchenDutyPlanningResourceWeekModel&gt; weeks = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">if</span> (users != <span class="hljs-keyword">null</span> &amp;&amp; users.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (Week week : users[<span class="hljs-number">0</span>].getWeeks()) {
                weeks.add(<span class="hljs-keyword">new</span> KitchenDutyPlanningResourceWeekModel(week.getID(), week.getWeek()));
            }
        }
        <span class="hljs-keyword">return</span> Response.ok(weeks).build();
    }
...
}</code></pre>

        </p>


        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResourceWeekModel.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/e923ee619b945042bc37217e78b3aead2f8a4b44/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResourceWeekModel.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;

@XmlRootElement(name = &quot;weeks&quot;)
@XmlAccessorType(XmlAccessType.FIELD)
public class KitchenDutyPlanningResourceWeekModel {

    @XmlElement
    private Integer id;

    @XmlElement
    private Integer week;

    KitchenDutyPlanningResourceWeekModel() { }

    KitchenDutyPlanningResourceWeekModel(Integer id, Integer week) {
        this.id = id;
        this.week = week;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public Integer getWeek() {
        return week;
    }

    public void setWeek(Integer week) {
        this.week = week;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessorType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlElement;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlRootElement;

<span class="hljs-annotation">@XmlRootElement</span>(name = <span class="hljs-string">"weeks"</span>)
<span class="hljs-annotation">@XmlAccessorType</span>(XmlAccessType.FIELD)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResourceWeekModel</span> </span>{

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> Integer week;

    KitchenDutyPlanningResourceWeekModel() { }

    KitchenDutyPlanningResourceWeekModel(Integer id, Integer week) {
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.week = week;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getWeek</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> week;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setWeek</span><span class="hljs-params">(Integer week)</span> </span>{
        <span class="hljs-keyword">this</span>.week = week;
    }
}</code></pre>

        </p>


        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResourceUserModel.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/e923ee619b945042bc37217e78b3aead2f8a4b44/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResourceUserModel.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;

@XmlRootElement(name = &quot;users&quot;)
@XmlAccessorType(XmlAccessType.FIELD)
public class KitchenDutyPlanningResourceUserModel {

    @XmlElement
    private Integer id;

    @XmlElement
    private String username;

    KitchenDutyPlanningResourceUserModel() { }

    KitchenDutyPlanningResourceUserModel(Integer id, String username) {
        this.id = id;
        this.username = username;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessorType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlElement;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlRootElement;

<span class="hljs-annotation">@XmlRootElement</span>(name = <span class="hljs-string">"users"</span>)
<span class="hljs-annotation">@XmlAccessorType</span>(XmlAccessType.FIELD)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResourceUserModel</span> </span>{

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> String username;

    KitchenDutyPlanningResourceUserModel() { }

    KitchenDutyPlanningResourceUserModel(Integer id, String username) {
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.username = username;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>{
        <span class="hljs-keyword">this</span>.username = username;
    }
}</code></pre>

        </p>

        <p>Now we can query</p>

        <p><strong>List assigned users for week 42.</strong></p>

        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">[{<span class="hljs-string">"id"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"username"</span>:<span class="hljs-string">"ichiban"</span>}]</code></pre>

    </div>
</div>


        <p><strong>List weeks for user ichiban.</strong></p>

        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/user/ichiban/weeks"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/user/ichiban/weeks<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">[{<span class="hljs-string">"id"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"week"</span>:<span class="hljs-number">42</span>}]</code></pre>

    </div>
</div>



        <p>
            We can discuss REST API URL structure all day and you can do the crazy stuff on your project but here we want to keep things
            simple. Therefore we will just add two more Endpoint types DELETE and PUT on /week/42/users.
            /user/{username}/weeks will stay with GET since this is just a convinience aggregation Endpoint.
        </p>


        <!--



                AO 1.2.0 - Indexes example: https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/ao-1-2-0-upgrade-guide
        -->





        <p>
            Now we add the functionality to <strong>add users to weeks and remove them from weeks</strong>.
            Therefore we will need a <strong>DELETE and PUT Endpoint</strong> which we add to <code>KitchenDutyPlanningResource</code> Class.
        </p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/e90e472228d0512b90d6ef2f6f1b9f3cae91c542/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="/**
     * Add the User to the Week
     *
     * @param isoWeekNumber
     * @return
     */
    @PUT
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response addUserToWeek(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber,
                                  final KitchenDutyPlanningResourceUserModel userParam) {
        activeObjects.executeInTransaction(new TransactionCallback&lt;Void&gt;() {
            @Override
            public Void doInTransaction() {
                //
                // WEEK
                //
                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, isoWeekNumber);
                if (week == null) {
                    week = activeObjects.create(Week.class, new DBParam(&quot;WEEK&quot;, isoWeekNumber));
                    week.save();
                }

                //
                // USER
                //
                User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                if (user == null) {
                    user = activeObjects.create(User.class, new DBParam(&quot;NAME&quot;, userParam.getUsername()));
                    user.save();
                }

                //
                // Establish ManyToMany Relationship
                //
                UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                if (relationship != null) {
                    // relation already exists
                    return null;
                }
                relationship = activeObjects.create(UserToWeek.class);
                relationship.setUser(user);
                relationship.setWeek(week);
                relationship.save();

                return null;
            }
        });
        return Response.ok().build();
    }


    /**
     * Remove the User from Week
     *
     * @param isoWeekNumber
     * @return
     */
    @DELETE
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response deleteUserFomWeek(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber,
                                  final KitchenDutyPlanningResourceUserModel userParam) {
        activeObjects.executeInTransaction(new TransactionCallback&lt;Void&gt;() {
            @Override
            public Void doInTransaction() {
                //
                // WEEK
                //
                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, isoWeekNumber);
                if (week == null) {
                    // week does not exist =&gt; no relation to delete
                    return null;
                }

                //
                // USER
                //
                User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                if (user == null) {
                    // user does not exist =&gt; no relation to delete
                    return null;
                }

                //
                // Delete ManyToMany Relationship
                //
                UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                if (relationship != null) {
                    activeObjects.delete(relationship);
                }

                return null;
            }
        });
        return Response.ok().build();
    }"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-comment">/**
     * Add the User to the Week
     *
     * <span class="hljs-doctag">@param</span> isoWeekNumber
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-annotation">@PUT</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">addUserToWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber,
                                  <span class="hljs-keyword">final</span> KitchenDutyPlanningResourceUserModel userParam) </span>{
        activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Void&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// WEEK</span>
                <span class="hljs-comment">//</span>
                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, isoWeekNumber);
                <span class="hljs-keyword">if</span> (week == <span class="hljs-keyword">null</span>) {
                    week = activeObjects.create(Week.class, <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"WEEK"</span>, isoWeekNumber));
                    week.save();
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// USER</span>
                <span class="hljs-comment">//</span>
                User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) {
                    user = activeObjects.create(User.class, <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"NAME"</span>, userParam.getUsername()));
                    user.save();
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// Establish ManyToMany Relationship</span>
                <span class="hljs-comment">//</span>
                UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                <span class="hljs-keyword">if</span> (relationship != <span class="hljs-keyword">null</span>) {
                    <span class="hljs-comment">// relation already exists</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
                }
                relationship = activeObjects.create(UserToWeek.class);
                relationship.setUser(user);
                relationship.setWeek(week);
                relationship.save();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        });
        <span class="hljs-keyword">return</span> Response.ok().build();
    }


    <span class="hljs-comment">/**
     * Remove the User from Week
     *
     * <span class="hljs-doctag">@param</span> isoWeekNumber
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-annotation">@DELETE</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">deleteUserFomWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber,
                                  <span class="hljs-keyword">final</span> KitchenDutyPlanningResourceUserModel userParam) </span>{
        activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Void&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// WEEK</span>
                <span class="hljs-comment">//</span>
                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, isoWeekNumber);
                <span class="hljs-keyword">if</span> (week == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-comment">// week does not exist =&gt; no relation to delete</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// USER</span>
                <span class="hljs-comment">//</span>
                User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-comment">// user does not exist =&gt; no relation to delete</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// Delete ManyToMany Relationship</span>
                <span class="hljs-comment">//</span>
                UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                <span class="hljs-keyword">if</span> (relationship != <span class="hljs-keyword">null</span>) {
                    activeObjects.delete(relationship);
                }

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        });
        <span class="hljs-keyword">return</span> Response.ok().build();
    }</code></pre>

        </p>

        <p>I moved some common data access spaghetti code to some static Methods a <code>KitchenDutyActiveObjectHelper</code> Class.</p>

        <p>
            

<div class="cs-code-filename">
    
    <span class="hidden-md-down">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="hidden-lg-up"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>KitchenDutyActiveObjectHelper.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/e90e472228d0512b90d6ef2f6f1b9f3cae91c542/step-04-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/KitchenDutyActiveObjectHelper.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

import com.atlassian.activeobjects.external.ActiveObjects;
import net.java.ao.Query;

public class KitchenDutyActiveObjectHelper {

    public static Week findUniqueWeek(ActiveObjects activeObjects, Integer isoWeekNumber) {
        Week[] weekRes = activeObjects.find(Week.class, Query.select().where(&quot;WEEK = ?&quot;, isoWeekNumber));
        if ((weekRes != null &amp;&amp; weekRes.length &gt; 0)) {
            return weekRes[0];
        }
        return null;
    }

    public static User findUniqueUser(ActiveObjects activeObjects, String username) {
        User[] userRes = activeObjects.find(User.class, Query.select().where(&quot;NAME = ?&quot;, username));
        if ((userRes != null &amp;&amp; userRes.length &gt; 0)) {
            return userRes[0];
        }
        return null;
    }

    public static UserToWeek findRelationship(ActiveObjects activeObjects, User user, Week week) {
        UserToWeek[] relationships = activeObjects.find(UserToWeek.class, Query.select().where(&quot;USER_ID = ? AND WEEK_ID = ?&quot;, user.getID(), week.getID()));
        if ((relationships  != null &amp;&amp; relationships .length &gt; 0)) {
            return relationships[0];
        }
        return null;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

<span class="hljs-keyword">import</span> com.atlassian.activeobjects.external.ActiveObjects;
<span class="hljs-keyword">import</span> net.java.ao.Query;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyActiveObjectHelper</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Week <span class="hljs-title">findUniqueWeek</span><span class="hljs-params">(ActiveObjects activeObjects, Integer isoWeekNumber)</span> </span>{
        Week[] weekRes = activeObjects.find(Week.class, Query.select().where(<span class="hljs-string">"WEEK = ?"</span>, isoWeekNumber));
        <span class="hljs-keyword">if</span> ((weekRes != <span class="hljs-keyword">null</span> &amp;&amp; weekRes.length &gt; <span class="hljs-number">0</span>)) {
            <span class="hljs-keyword">return</span> weekRes[<span class="hljs-number">0</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User <span class="hljs-title">findUniqueUser</span><span class="hljs-params">(ActiveObjects activeObjects, String username)</span> </span>{
        User[] userRes = activeObjects.find(User.class, Query.select().where(<span class="hljs-string">"NAME = ?"</span>, username));
        <span class="hljs-keyword">if</span> ((userRes != <span class="hljs-keyword">null</span> &amp;&amp; userRes.length &gt; <span class="hljs-number">0</span>)) {
            <span class="hljs-keyword">return</span> userRes[<span class="hljs-number">0</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserToWeek <span class="hljs-title">findRelationship</span><span class="hljs-params">(ActiveObjects activeObjects, User user, Week week)</span> </span>{
        UserToWeek[] relationships = activeObjects.find(UserToWeek.class, Query.select().where(<span class="hljs-string">"USER_ID = ? AND WEEK_ID = ?"</span>, user.getID(), week.getID()));
        <span class="hljs-keyword">if</span> ((relationships  != <span class="hljs-keyword">null</span> &amp;&amp; relationships .length &gt; <span class="hljs-number">0</span>)) {
            <span class="hljs-keyword">return</span> relationships[<span class="hljs-number">0</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }
}</code></pre>

        </p>

        <p>Basically we query the table with unique constraints on the columns of the where clause so we get either one result or no result.</p>
        <p>Note that these Queries need to be spaced (at least the doc says so) otherwise Exceptions will punch you.</p>



        <p>Now we can fire up <code>atlas-run</code> once more and wait for JIRA startup.</p>

        <p><strong>Let's add a user called jimmy to a week 42</strong>. Fire up this curl command and you should return a HTTP 200 telling you it worked.
        We have written our Endpoints in a way so that the CURLs are idemponent. So if you fire it a second time you will get a HTTP 200 as well but since jimmy already is assigned to week 42 nothing happens internally.</p>

        <p>And by the way, we don't need to pass an ID for user since we don't know it and since the username has a unique constraint which makes it our technical primary key.</p>

        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl -i --user admin:admin -H &#39;Content-Type: application/json&#39; -X PUT -d &#39;{ &quot;username&quot;: &quot;jimmy&quot; }&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl -i --user admin:admin -H &#39;Content-Type: application/json&#39; -X PUT -d &#39;{ &quot;username&quot;: &quot;jimmy&quot; }&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
...
Content-Type: application/json;charset=UTF-<span class="hljs-number">8</span>
Content-Length: <span class="hljs-number">0</span>
Date: Fri, <span class="hljs-number">09</span> Sep <span class="hljs-number">2016</span> <span class="hljs-number">16</span>:<span class="hljs-number">52</span>:<span class="hljs-number">06</span> GMT</code></pre>

    </div>
</div>


        <p><strong>Let's remove a user called ichiban from week 42.</strong></p>

        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl -i --user admin:admin -H &#39;Content-Type: application/json&#39; -X DELETE -d &#39;{ &quot;username&quot;: &quot;ichiban&quot; }&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl -i --user admin:admin -H &#39;Content-Type: application/json&#39; -X DELETE -d &#39;{ &quot;username&quot;: &quot;ichiban&quot; }&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
...
Content-Type: application/json;charset=UTF-<span class="hljs-number">8</span>
Content-Length: <span class="hljs-number">0</span>
Date: Fri, <span class="hljs-number">09</span> Sep <span class="hljs-number">2016</span> <span class="hljs-number">16</span>:<span class="hljs-number">52</span>:<span class="hljs-number">06</span> GMT</code></pre>

    </div>
</div>


        <p><strong>List assigned users for week 42.</strong></p>

        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl --user admin:admin -H &#39;Content-Type: application/json&#39; http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">[{<span class="hljs-string">"id"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"username"</span>:<span class="hljs-string">"jimmy"</span>}]</code></pre>

    </div>
</div>







        <div class="alert alert-danger">THIS PAGE IS UNDER CONSTRUCTION. WORK IN PROGRESS</div>


        <!--
                <div class="cs-v-spacer"></div>
                <div class="cs-tutorial-step-review">
                    <div class="cs-tutorial-step-review__headline">
                        <strong>You have completed Step 4.</strong> Good Job! You can check out this steps solution on GitHub
                    </div>
                    <div class="cs-tutorial-step-review__link">
                        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-04-kitchen-duty-plugin">
                            https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-04-kitchen-duty-plugin
                        </a>
                    </div>
                </div>
                <div class="cs-v-spacer"></div>
                <p>The graphic shows marked green <strong>which components we implemented in this section</strong>.</p>
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-10 col-lg-offset-1 col-xl-8 col-xl-offset-2">
                        
<svg class="cs-interactive-graphic"
     id="p07-ig01"
     data-json-settings="{
                            &quot;markedAsDone&quot;: [ &quot;webwork-action&quot;, &quot;html-view&quot;, &quot;user-resource&quot;, &quot;user-search-resource-model&quot;, &quot;user-js-controller&quot;, &quot;kitchen-duty-resource&quot;, &quot;kitchen-duty-planning-model&quot; ],
                            &quot;markedAsTodo&quot;: [  ],
                            &quot;markedAsGrayedOut&quot;: [ ],
                            &quot;onClick&quot;: [ ]
                        }"
     data-svg-to-load="kitchen-duty-planning-page--component-overview"
     viewBox="0 0 1043 654"
     preserveAspectRatio="xMaxYMax">
</svg>

                    </div>
                </div>
        -->
        <div class="cs-v-spacer cs-v-spacer--big"></div>
        <div class="cs-v-spacer cs-v-spacer--big"></div>

    </div>
</div>



</div>



<div class="cs-footer">
    <div class="cs-footer-left">
        <a class="cs-grey-footer-link" href="/kitchen-duty-plugin-for-atlassian-jira/author-and-license/">Author &amp; License</a> &middot;
        <a class="cs-grey-footer-link" href="/kitchen-duty-plugin-for-atlassian-jira/impressum-and-datenschutz/">Impressum &amp; Datenschutz</a>
        &middot;
        <a class="cs-grey-footer-link" href="/kitchen-duty-plugin-for-atlassian-jira/impressum-and-datenschutz/">Privacy</a>
    </div>
    <div class="cs-footer-right">
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 cs-pager cs-page-header--left-fix">
                            <a class="btn btn-primary" href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/06-step-03-planning-page--user-search-js-controller/"><i class="fa fa-angle-left"></i>
                                <span class="hidden-sm-down">previous page</span></a>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 text-xs-right cs-pager cs-page-header--right-fix">
                            
                            <a class="btn btn-primary" href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/08-step-05-planning-page--kitchen-duty-planning-js-controller/">
                                <span class="hidden-sm-down">next page</span>
                                <i class="fa fa-angle-right"></i></a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>







<script src="/kitchen-duty-plugin-for-atlassian-jira/generated/bundle.js" async></script>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<script>
    WebFont.load({
        google: {
            families: [ 'Menlo',
                'Open+Sans:400,300,600,700,800',
                'Roboto:400,900,700',
                'Source+Sans+Pro:400,300,600',
                'Patrick+Hand'
            ]
        }
    });
</script>
</body>
</html>
